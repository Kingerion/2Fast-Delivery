<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2Fast Delivery</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f4; }
        
        #map { height: 55vh; width: 100%; z-index: 1; }
        
        /* ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î¿ Î¬ÏƒÏ‡Î·Î¼Î¿ ÎºÎ¿Ï…Ï„Î¯ Î¿Î´Î·Î³Î¹ÏÎ½ Ï„Î¿Ï… Leaflet */
        .leaflet-routing-container { display: none !important; }

        .container { 
            padding: 20px; 
            background: white; 
            border-radius: 20px 20px 0 0; 
            position: relative; 
            top: -20px; 
            z-index: 999;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); 
        }

        h2 { margin-top: 0; color: #333; text-align: center; font-size: 20px; }
        .instructions { text-align: center; font-size: 14px; color: #666; margin-bottom: 15px; background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px solid #ffe0b2; }
        
        .input-group { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px; display: block; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        /* Î¤Î± readonly Ï€ÎµÎ´Î¯Î± Ï„Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î»Î¯Î³Î¿ Ï€Î¹Î¿ Î³ÎºÏÎ¹ Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÏŒÏ„Î¹ Î´ÎµÎ½ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚ */
        input[readonly] { background-color: #eee; color: #555; cursor: pointer; }
        
        textarea { resize: vertical; height: 70px; }
        
        .price-box { background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; border: 2px solid #2196f3; }
        .price-value { font-size: 26px; font-weight: bold; color: #1565c0; }
        .distance-info { font-size: 14px; color: #555; margin-top: 5px; }

        button { width: 100%; padding: 16px; background: #ff5722; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        button:active { background: #e64a19; transform: scale(0.98); }

        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff5722; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <h2>Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î”Î­Î¼Î±Ï„Î¿Ï‚</h2>
        <div class="instructions">
            ğŸ“ <strong>ÎŸÎ´Î·Î³Î¯ÎµÏ‚:</strong><br>
            1. Î Î¬Ï„Î± ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î· Î³Î¹Î± <b>Î Î±ÏÎ±Î»Î±Î²Î®</b>.<br>
            2. Î Î¬Ï„Î± Î¾Î±Î½Î¬ Î³Î¹Î± <b>Î Î±ÏÎ¬Î´Î¿ÏƒÎ·</b>.
        </div>
        
        <div class="input-group">
            <input type="tel" id="phone" placeholder="Î¤Î¿ Ï„Î·Î»Î­Ï†Ï‰Î½ÏŒ ÏƒÎ±Ï‚" required>
        </div>
        
        <div class="input-group">
            <label>Î‘Ï†ÎµÏ„Î·ÏÎ¯Î± (Î Î¬Ï„Î± ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î·)</label>
            <input type="text" id="start" placeholder="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÎ·Î¼ÎµÎ¯Î¿..." readonly>
        </div>
        <div class="input-group">
            <label>Î ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ (Î Î¬Ï„Î± ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î·)</label>
            <input type="text" id="end" placeholder="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÎ·Î¼ÎµÎ¯Î¿..." readonly>
        </div>

        <div class="input-group">
            <textarea id="comments" placeholder="Î£Ï‡ÏŒÎ»Î¹Î± (Ï€.Ï‡. ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹, ÎŒÏÎ¿Ï†Î¿Ï‚, ÎŒÎ½Î¿Î¼Î±)"></textarea>
        </div>

        <div class="price-box">
            <div style="font-size: 14px; color: #777;">Î•ÎºÏ„Î¹Î¼ÏÎ¼ÎµÎ½Î¿ ÎšÏŒÏƒÏ„Î¿Ï‚</div>
            <div class="price-value" id="priceDisplay">0.00 â‚¬</div>
            <div class="distance-info" id="distDisplay">-</div>
        </div>

        <button id="sendBtn" onclick="sendOrder()" disabled>
            <span id="btnText">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</span>
            <div class="loader" id="loader"></div>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ ---
        // Î’Î‘Î›Î• Î¤ÎŸ URL Î£ÎŸÎ¥ Î•Î”Î©
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_XXXXXXXXXXXX/exec"; 
        // -----------------

        var map = L.map('map').setView([37.9838, 23.7275], 13); // Î‘Î¸Î®Î½Î±
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: false,
            // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ OSRM Î³Î¹Î± Î´ÏÏŒÎ¼Î¿Ï…Ï‚ (ÏŒÏ‡Î¹ ÎµÏ…Î¸ÎµÎ¯Î± Î³ÏÎ±Î¼Î¼Î®)
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            }),
            show: false, // ÎšÏÏÎ²ÎµÎ¹ Ï„Î¿ Ï€Î¬Î½ÎµÎ»
            addWaypoints: false, // Î‘Ï€Î±Î³Î¿ÏÎµÏÎµÎ¹ Î½Î± ÏƒÎ­ÏÎ½ÎµÎ¹Ï‚ Ï„Î· Î³ÏÎ±Î¼Î¼Î® (Î³Î¹Î± Î±Ï€Î»ÏŒÏ„Î·Ï„Î±)
            createMarker: function(i, wp, nWps) {
                // Î•Î¹Î´Î¹ÎºÎ¬ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î± Î³Î¹Î± Î‘ÏÏ‡Î® (Î ÏÎ¬ÏƒÎ¹Î½Î¿) ÎºÎ±Î¹ Î¤Î­Î»Î¿Ï‚ (ÎšÏŒÎºÎºÎ¹Î½Î¿)
                var color = (i === 0) ? 'green' : 'red';
                return L.marker(wp.latLng, {
                    draggable: false
                });
            }
        }).addTo(map);

        // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Î³Î¹Î± Ï„Î± ÏƒÎ·Î¼ÎµÎ¯Î±
        var startPoint = null;
        var endPoint = null;
        var calculatedPrice = 0;

        // --- Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘ ÎšÎ›Î™Îš Î£Î¤ÎŸ Î§Î‘Î¡Î¤Î— ---
        map.on('click', function(e) {
            // Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· 1: Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Ï†ÎµÏ„Î·ÏÎ¯Î± -> Î’Î¬Î»Îµ Î‘Ï†ÎµÏ„Î·ÏÎ¯Î±
            if (!startPoint) {
                startPoint = e.latlng;
                
                // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI
                document.getElementById('start').value = "Î£Î·Î¼ÎµÎ¯Î¿: " + startPoint.lat.toFixed(4) + ", " + startPoint.lng.toFixed(4);
                
                // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î´ÎµÎ¯ÎºÏ„Î· (Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Î¼Î­Ï‡ÏÎ¹ Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹ Ï„Î¿ routing)
                routingControl.setWaypoints([startPoint]);
                
            } 
            // Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· 2: Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Ï†ÎµÏ„Î·ÏÎ¯Î±, Î±Î»Î»Î¬ ÏŒÏ‡Î¹ Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ -> Î’Î¬Î»Îµ Î ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒ & Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ
            else if (!endPoint) {
                endPoint = e.latlng;
                
                // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI
                document.getElementById('end').value = "Î£Î·Î¼ÎµÎ¯Î¿: " + endPoint.lat.toFixed(4) + ", " + endPoint.lng.toFixed(4);
                
                // Î•ÎšÎ¤Î•Î›Î•Î£Î— ROUTING
                routingControl.setWaypoints([startPoint, endPoint]);
            } 
            // Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· 3: Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ -> ÎšÎ¬Î½Îµ Reset ÎºÎ±Î¹ Î¾ÎµÎºÎ¯Î½Î± Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®
            else {
                startPoint = e.latlng;
                endPoint = null;
                document.getElementById('start').value = "Î£Î·Î¼ÎµÎ¯Î¿: " + startPoint.lat.toFixed(4) + ", " + startPoint.lng.toFixed(4);
                document.getElementById('end').value = "";
                document.getElementById('priceDisplay').innerText = "0.00 â‚¬";
                document.getElementById('distDisplay').innerText = "-";
                document.getElementById('sendBtn').disabled = true;
                
                routingControl.setWaypoints([startPoint]);
            }
        });

        // ÎŒÏ„Î±Î½ Î²ÏÎµÎ¸ÎµÎ¯ Î´Î¹Î±Î´ÏÎ¿Î¼Î®
        routingControl.on('routesfound', function(e) {
            var routes = e.routes;
            var summary = routes[0].summary;
            var distKm = summary.totalDistance / 1000; // Î§Î¹Î»Î¹ÏŒÎ¼ÎµÏ„ÏÎ±
            
            // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î¤Î¹Î¼Î®Ï‚
            calculatedPrice = calculateComplexPrice(distKm);
            
            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎŸÎ¸ÏŒÎ½Î·Ï‚
            document.getElementById('priceDisplay').innerText = calculatedPrice.toFixed(2) + " â‚¬";
            document.getElementById('distDisplay').innerText = distKm.toFixed(1) + " Ï‡Î»Î¼ â€¢ ~" + Math.round(summary.totalTime / 60) + " Î»ÎµÏ€Ï„Î¬";
            
            // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï
            document.getElementById('sendBtn').disabled = false;
            
            // ÎšÎµÎ½Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Ï‡Î¬ÏÏ„Î· ÏƒÏ„Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î®
            // map.fitBounds(L.latLngBounds([startPoint, endPoint]));
        });

        // --- Î— Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î¤Î—Î£ Î§Î¡Î•Î©Î£Î—Î£ (3â‚¬, Î¼ÎµÏ„Î¬ 0.50â‚¬, Î¼ÎµÏ„Î¬ +0.10â‚¬) ---
        function calculateComplexPrice(km) {
            let price = 0;
            
            // 0-1 Ï‡Î»Î¼ -> Î£Ï„Î±Î¸ÎµÏÎ¬ 3â‚¬
            if (km <= 1) return 3.00;

            price = 3.00;
            let remaining = km - 1;

            // 1-4 Ï‡Î»Î¼ -> 0.50â‚¬
            if (remaining <= 3) {
                price += remaining * 0.50;
                return price;
            }

            // Î ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ ÏŒÎ»Î· Ï„Î· Î¶ÏÎ½Î· 1-4 (1.50â‚¬)
            price += 1.50;
            remaining -= 3;

            // 4+ Ï‡Î»Î¼ -> ÎšÎ»Î¹Î¼Î±ÎºÏ‰Ï„Î® Î±ÏÎ¾Î·ÏƒÎ·
            let rate = 0.60;
            while (remaining > 0) {
                let chunk = remaining >= 1 ? 1 : remaining;
                price += chunk * rate;
                remaining -= 1;
                rate += 0.10;
            }
            return price;
        }

        function sendOrder() {
            var phone = document.getElementById('phone').value;
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            var comments = document.getElementById('comments').value;

            if (!phone) { alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î·Î»Î­Ï†Ï‰Î½Î¿!"); return; }

            document.getElementById('sendBtn').disabled = true;
            document.getElementById('btnText').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            var orderData = {
                phone: phone,
                start: start + " (Lat/Lon)",
                end: end + " (Lat/Lon)",
                comments: comments,
                price: calculatedPrice.toFixed(2),
                dist: document.getElementById('distDisplay').innerText
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            }).then(() => {
                alert("Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÎµÏƒÏ„Î¬Î»Î·!");
                location.reload();
            }).catch(error => {
                alert("Î£Ï†Î¬Î»Î¼Î±: " + error);
                location.reload();
            });
        }
    </script>
</body>
</html>
