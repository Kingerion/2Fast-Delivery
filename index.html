<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2Fast Delivery</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f4; }
        
        #map { height: 45vh; width: 100%; z-index: 1; }
        .leaflet-routing-container { display: none !important; }

        .container { 
            padding: 20px; 
            background: white; 
            border-radius: 20px 20px 0 0; 
            position: relative; 
            top: -20px; 
            z-index: 999;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); 
        }

        h2 { margin-top: 0; color: #333; text-align: center; font-size: 20px; }
        .instructions { text-align: center; font-size: 13px; color: #666; margin-bottom: 15px; background: #fff3e0; padding: 8px; border-radius: 8px; border: 1px solid #ffe0b2; }
        
        .input-group { margin-bottom: 15px; }
        label { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; display: block; }
        
        .input-wrapper { display: flex; gap: 8px; position: relative; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        input:focus { border-color: #2196f3; outline: none; }
        
        /* ÎšÎ¿Ï…Î¼Ï€Î¯ Î¦Î±ÎºÏŒÏ‚ - Î Î¹Î¿ Î¼ÎµÎ³Î¬Î»Î¿ ÎºÎ±Î¹ Î­Î½Ï„Î¿Î½Î¿ */
        .search-btn { 
            background: #2196f3; 
            color: white;
            border: none; 
            border-radius: 8px; 
            width: 60px; 
            cursor: pointer; 
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .search-btn:active { background: #1976d2; transform: scale(0.95); }
        .search-btn.loading { background: #ccc; pointer-events: none; }
        .search-btn.loading::after { content: "âŒ›"; font-size: 16px; animation: spin 1s infinite linear; }

        textarea { resize: vertical; height: 70px; }
        
        .price-box { background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; border: 2px solid #2196f3; }
        .price-value { font-size: 28px; font-weight: bold; color: #1565c0; }
        .distance-info { font-size: 15px; color: #555; margin-top: 5px; font-weight: 500; }

        button#sendBtn { width: 100%; padding: 16px; background: #ff5722; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff5722; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <h2>Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î”Î­Î¼Î±Ï„Î¿Ï‚</h2>
        <div class="instructions">
            ğŸ“ Î Î¬Ï„Î± ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î· <b>Î‰</b><br>
            âœï¸ Î“ÏÎ¬ÏˆÎµ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎºÎ±Î¹ <b>Î Î‘Î¤Î‘ Î¤ÎŸÎ ÎœÎ Î›Î• Î¦Î‘ÎšÎŸ ğŸ”</b>
        </div>
        
        <div class="input-group">
            <label>Î¤Î¿ Ï„Î·Î»Î­Ï†Ï‰Î½ÏŒ ÏƒÎ±Ï‚</label>
            <input type="tel" id="phone" placeholder="Ï€.Ï‡. 6900000000" required>
        </div>
        
        <div class="input-group">
            <label>Î‘Ï€ÏŒ Î Î¿Ï; (Î Î±ÏÎ±Î»Î±Î²Î®)</label>
            <div class="input-wrapper">
                <input type="text" id="start" placeholder="ÎŸÎ´ÏŒÏ‚ ÎºÎ±Î¹ Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚..." >
                <button class="search-btn" id="btn-start" onclick="smartSearch('start')">ğŸ”</button>
            </div>
        </div>

        <div class="input-group">
            <label>Î Î¿Ï Î Î¬ÎµÎ¹; (Î Î±ÏÎ¬Î´Î¿ÏƒÎ·)</label>
            <div class="input-wrapper">
                <input type="text" id="end" placeholder="ÎŸÎ´ÏŒÏ‚ ÎºÎ±Î¹ Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚..." >
                <button class="search-btn" id="btn-end" onclick="smartSearch('end')">ğŸ”</button>
            </div>
        </div>

        <div class="input-group">
            <textarea id="comments" placeholder="Î£Ï‡ÏŒÎ»Î¹Î± (Ï€.Ï‡. ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹, ÎŒÏÎ¿Ï†Î¿Ï‚, ÎŒÎ½Î¿Î¼Î±)"></textarea>
        </div>

        <div class="price-box">
            <div style="font-size: 14px; color: #777;">Î•ÎºÏ„Î¹Î¼ÏÎ¼ÎµÎ½Î¿ ÎšÏŒÏƒÏ„Î¿Ï‚</div>
            <div class="price-value" id="priceDisplay">0.00 â‚¬</div>
            <div class="distance-info" id="distDisplay">-</div>
        </div>

        <button id="sendBtn" onclick="sendOrder()">
            <span id="btnText">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</span>
            <div class="loader" id="loader"></div>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // --- Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ ---
        // ğŸ”´ Î’Î‘Î›Î• Î¤ÎŸ Î”Î™ÎšÎŸ Î£ÎŸÎ¥ LINK Î•Î”Î©:
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_XXXXXXXXXXXX/exec"; 
        
        // ğŸŸ¢ Î¤ÎŸ Î¤Î—Î›Î•Î¦Î©ÎÎŸ Î£ÎŸÎ¥ (Î§Ï‰ÏÎ¯Ï‚ +)
        const MY_PHONE = "306934021792";
        // -----------------

        var map = L.map('map').setView([37.9838, 23.7275], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        var geocoder = L.Control.Geocoder.nominatim();
        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: false,
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
            show: false,
            addWaypoints: false,
            createMarker: function(i, wp) {
                return L.marker(wp.latLng, { draggable: false });
            }
        }).addTo(map);

        var startPoint = null, endPoint = null, calculatedPrice = 0;

        // 1. Enter Key Listener
        function setupEnterKey(id, type) {
            document.getElementById(id).addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById(id).blur();
                    smartSearch(type);
                }
            });
        }
        setupEnterKey("start", "start");
        setupEnterKey("end", "end");

        // 2. ÎšÎ›Î™Îš Î£Î¤ÎŸ Î§Î‘Î¡Î¤Î— (Î”Î¹Î¿ÏÎ¸Ï‰Î¼Î­Î½Î¿ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¿Î½ÏŒÎ¼Î±Ï„Î±)
        map.on('click', function(e) { handleMapClick(e.latlng); });

        function handleMapClick(latlng) {
            // Î’Î¬Î¶Î¿Ï…Î¼Îµ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Ï„Î¹Ï‚ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚ Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ¿Î»Î»Î®ÏƒÎµÎ¹ Î¿ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
            var coordsText = latlng.lat.toFixed(5) + ", " + latlng.lng.toFixed(5);
            
            if (!startPoint) {
                startPoint = latlng;
                document.getElementById('start').value = "Î•ÏÏÎµÏƒÎ· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚..."; 
                reverseGeocode(latlng, 'start'); // Î¨Î¬Ï‡Î½ÎµÎ¹ Ï„Î¿ ÏŒÎ½Î¿Î¼Î±
                updateRoute();
            } else if (!endPoint) {
                endPoint = latlng;
                document.getElementById('end').value = "Î•ÏÏÎµÏƒÎ· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚..."; 
                reverseGeocode(latlng, 'end');
                updateRoute();
            } else {
                resetMap();
                handleMapClick(latlng);
            }
        }

        // 3. Î•ÎÎ¥Î ÎÎ— Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î— (Smart Search)
        function smartSearch(type) {
            var inputId = type === 'start' ? 'start' : 'end';
            var btnId = type === 'start' ? 'btn-start' : 'btn-end';
            var query = document.getElementById(inputId).value;
            
            if (query.length < 2) return;
            if (query.includes("Î•ÏÏÎµÏƒÎ·") || query.includes("Lat")) return;

            // Î”ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹
            var btn = document.getElementById(btnId);
            var originalBtnText = btn.innerHTML;
            btn.classList.add("loading");
            btn.innerHTML = ""; 

            // Î›Î™Î£Î¤Î‘ Î”ÎŸÎšÎ™ÎœÎ©Î: Î¨Î¬Ï‡Î½ÎµÎ¹ Î¼Îµ Ï€Î¿Î»Î»Î¿ÏÏ‚ Ï„ÏÏŒÏ€Î¿Ï…Ï‚ Î¼Î­Ï‡ÏÎ¹ Î½Î± Ï„Î¿ Î²ÏÎµÎ¹
            var attempts = [
                query, // Î£ÎºÎ­Ï„Î¿
                query + ", Î ÎµÎ¹ÏÎ±Î¹Î¬Ï‚", // Î”Î¿ÎºÎ¹Î¼Î® Î¼Îµ Î ÎµÎ¹ÏÎ±Î¹Î¬
                query + ", Î‘Î¸Î®Î½Î±", // Î”Î¿ÎºÎ¹Î¼Î® Î¼Îµ Î‘Î¸Î®Î½Î±
                query + ", Î‘Ï„Ï„Î¹ÎºÎ®", // Î”Î¿ÎºÎ¹Î¼Î® Î¼Îµ Î‘Ï„Ï„Î¹ÎºÎ®
                query + ", Î•Î»Î»Î¬Î´Î±" // Î“ÎµÎ½Î¹ÎºÎ¬
            ];

            runSearchAttempt(attempts, 0, type, inputId, btn, originalBtnText);
        }

        function runSearchAttempt(attempts, index, type, inputId, btn, originalBtnText) {
            if (index >= attempts.length) {
                // Î¤Î­Î»Î¿Ï‚ Ï€ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¹ÏÎ½ - Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ
                alert("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·. Î Î±Ï„Î®ÏƒÏ„Îµ Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î·!");
                btn.classList.remove("loading");
                btn.innerHTML = originalBtnText;
                return;
            }

            var currentQuery = attempts[index];
            console.log("Searching for:", currentQuery); // Î“Î¹Î± debugging

            geocoder.geocode(currentQuery, function(results) {
                if (results && results.length > 0) {
                    // Î’Î¡Î•Î˜Î—ÎšÎ•!
                    applyResult(results[0], type, inputId);
                    btn.classList.remove("loading");
                    btn.innerHTML = originalBtnText;
                } else {
                    // Î”Î•Î Î’Î¡Î•Î˜Î—ÎšÎ• -> Î Î¬Î¼Îµ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±
                    runSearchAttempt(attempts, index + 1, type, inputId, btn, originalBtnText);
                }
            });
        }

        function applyResult(r, type, inputId) {
            if (type === 'start') { 
                startPoint = r.center; 
                map.panTo(r.center); 
            } else { 
                endPoint = r.center; 
            }
            
            // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î±
            var cleanName = r.name;
            if (r.properties && r.properties.address) {
                 var road = r.properties.address.road || "";
                 var number = r.properties.address.house_number || "";
                 var suburb = r.properties.address.suburb || r.properties.address.city || r.properties.address.town || "";
                 
                 if (road) cleanName = road + " " + number;
                 if (suburb) cleanName += ", " + suburb;
            }
            
            document.getElementById(inputId).value = cleanName || r.name;
            updateRoute();
        }

        // 4. Reverse Geocoding (ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î± Î£Ï…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½Ï‰Î½)
        function reverseGeocode(latlng, type) {
            geocoder.reverse(latlng, map.options.crs.scale(map.getZoom()), function(results) {
                if (results && results.length > 0) {
                    var r = results[0];
                    var addressText = r.name;
                    
                    if (r.properties && r.properties.address) {
                        var road = r.properties.address.road || "";
                        var number = r.properties.address.house_number || "";
                        var suburb = r.properties.address.suburb || r.properties.address.city || r.properties.address.town || "";
                        
                        // Î¦Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Ï‰ÏÎ±Î¯Î¿ ÏŒÎ½Î¿Î¼Î±
                        if (road) addressText = road + " " + number;
                        else if (suburb) addressText = suburb; // Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´ÏÏŒÎ¼Î¿, Î²Î¬Î»Îµ Ï€ÎµÏÎ¹Î¿Ï‡Î®
                        
                        if (suburb && road) addressText += ", " + suburb;
                    }
                    document.getElementById(type).value = addressText;
                } else {
                    // Î‘Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ Ï„ÎµÎ»ÎµÎ¯Ï‰Ï‚, Î²Î¬Î»Îµ Ï„Î¹Ï‚ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚ Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¼ÎµÎ¯Î½ÎµÎ¹ ÎºÎµÎ½ÏŒ
                    document.getElementById(type).value = latlng.lat.toFixed(5) + ", " + latlng.lng.toFixed(5);
                }
            });
        }

        function updateRoute() {
            if (startPoint && endPoint) {
                routingControl.setWaypoints([startPoint, endPoint]);
            } else if (startPoint) {
                routingControl.setWaypoints([startPoint]);
            }
        }

        function resetMap() {
            startPoint = null; endPoint = null;
            document.getElementById('start').value = "";
            document.getElementById('end').value = "";
            document.getElementById('priceDisplay').innerText = "0.00 â‚¬";
            document.getElementById('distDisplay').innerText = "-";
            routingControl.setWaypoints([]);
        }

        routingControl.on('routesfound', function(e) {
            var summary = e.routes[0].summary;
            var distKm = summary.totalDistance / 1000;
            calculatedPrice = calculateComplexPrice(distKm);
            
            document.getElementById('priceDisplay').innerText = calculatedPrice.toFixed(2) + " â‚¬";
            document.getElementById('distDisplay').innerText = distKm.toFixed(1) + " Ï‡Î»Î¼ â€¢ ~" + Math.round(summary.totalTime / 60) + " Î»ÎµÏ€Ï„Î¬";
        });

        // Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ Î¤Î™ÎœÎ—Î£
        function calculateComplexPrice(km) {
            if (km <= 1) return 3.00;
            let price = 3.00;
            let remaining = km - 1;
            if (remaining <= 3) { price += remaining * 0.50; return price; }
            price += 1.50; remaining -= 3;
            let rate = 0.60;
            while (remaining > 0) {
                let chunk = remaining >= 1 ? 1 : remaining;
                price += chunk * rate;
                remaining -= 1; rate += 0.10;
            }
            return price;
        }

        // Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—
        function sendOrder() {
            var phone = document.getElementById('phone').value;
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            var comments = document.getElementById('comments').value;
            var price = calculatedPrice.toFixed(2);

            if (!phone) { alert("âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î·Î»Î­Ï†Ï‰Î½Î¿!"); return; }
            
            // Î•Î›Î•Î“Î§ÎŸÎ£: Î‘Î½ Î· Ï„Î¹Î¼Î® ÎµÎ¯Î½Î±Î¹ 0
            if (price == "0.00" || price == 0) {
                alert("âš ï¸ Î— Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„ÎµÎ¯!\n\nÎ Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¿Ï…Ï‚ ÎœÎ Î›Î• Î¦Î‘ÎšÎŸÎ¥Î£ ğŸ” Î´Î¯Ï€Î»Î± ÏƒÏ„Î¹Ï‚ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚!");
                return;
            }

            document.getElementById('sendBtn').disabled = true;
            document.getElementById('btnText').innerText = "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...";
            document.getElementById('loader').style.display = 'block';

            // WhatsApp
            var waText = "*ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±!* ğŸ“¦\n" +
                         "ğŸ“ Î¤Î·Î»: " + phone + "\n" +
                         "ğŸ“ Î‘Ï€ÏŒ: " + start + "\n" +
                         "ğŸ Î ÏÎ¿Ï‚: " + end + "\n" +
                         "ğŸ’¬ Î£Ï‡ÏŒÎ»Î¹Î±: " + comments + "\n" +
                         "ğŸ’° ÎšÏŒÏƒÏ„Î¿Ï‚: " + price + " â‚¬";
            
            var waLink = "https://wa.me/" + MY_PHONE + "?text=" + encodeURIComponent(waText);
            window.open(waLink, '_blank');

            // Shipday
            var orderData = {
                phone: phone,
                start: start,
                end: end,
                comments: comments,
                price: price,
                dist: document.getElementById('distDisplay').innerText
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            }).then(() => {
                setTimeout(function(){
                    alert("âœ… Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÎµÏƒÏ„Î¬Î»Î·!");
                    location.reload();
                }, 1000);
            }).catch(error => {
                alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: " + error);
                location.reload();
            });
        }
    </script>
</body>
</html>
