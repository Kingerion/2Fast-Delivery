<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2Fast Delivery</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f4; }
        #map { height: 50vh; width: 100%; }
        .container { padding: 20px; background: white; border-radius: 20px 20px 0 0; position: relative; top: -20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; text-align: center; }
        
        .input-group { margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; height: 80px; }
        
        .price-box { background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; border: 2px solid #2196f3; }
        .price-value { font-size: 24px; font-weight: bold; color: #1565c0; }
        .distance-info { font-size: 14px; color: #555; margin-top: 5px; }

        button { width: 100%; padding: 15px; background: #ff5722; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        button:disabled { background: #ccc; }
        button:active { background: #e64a19; }

        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff5722; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <h2>Αποστολή Δέματος</h2>
        
        <div class="input-group">
            <input type="tel" id="phone" placeholder="Το τηλέφωνό σας" required>
        </div>
        
        <div class="input-group">
            <input type="text" id="start" placeholder="Σημείο Παραλαβής (Από Χάρτη)" readonly>
        </div>
        <div class="input-group">
            <input type="text" id="end" placeholder="Σημείο Παράδοσης (Από Χάρτη)" readonly>
        </div>

        <div class="input-group">
            <textarea id="comments" placeholder="Σχόλια (π.χ. Κουδούνι, Όροφος, Όνομα)"></textarea>
        </div>

        <div class="price-box">
            <div>Εκτιμώμενο Κόστος:</div>
            <div class="price-value" id="priceDisplay">0.00 €</div>
            <div class="distance-info" id="distDisplay">Επιλέξτε διαδρομή στον χάρτη</div>
        </div>

        <button id="sendBtn" onclick="sendOrder()" disabled>
            <span id="btnText">Αποστολή Παραγγελίας</span>
            <div class="loader" id="loader"></div>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- ΡΥΘΜΙΣΕΙΣ ---
        // ΒΑΛΕ ΕΔΩ ΤΟ LINK ΑΠΟ ΤΟ GOOGLE SCRIPT ΣΟΥ (Version 3 ή όποιο δουλεύει)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_XXXXXXXXXXXX/exec"; 
        // -----------------

        var map = L.map('map').setView([37.9838, 23.7275], 13); // Κέντρο Αθήνα
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var control = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            geocoder: L.Control.Geocoder ? L.Control.Geocoder.nominatim() : null,
            createMarker: function() { return null; }, // Κρύβουμε τους default markers για να είναι καθαρό
            show: false // Κρύβουμε τις γραπτές οδηγίες
        }).addTo(map);

        var calculatedPrice = 0;

        // Όταν βρεθεί διαδρομή
        control.on('routesfound', function(e) {
            var routes = e.routes;
            var summary = routes[0].summary;
            var distKm = summary.totalDistance / 1000;
            
            // Υπολογισμός Τιμής με τον ΝΕΟ ΤΥΠΟ
            calculatedPrice = calculateComplexPrice(distKm);
            
            // Ενημέρωση οθόνης
            document.getElementById('priceDisplay').innerText = calculatedPrice.toFixed(2) + " €";
            document.getElementById('distDisplay').innerText = distKm.toFixed(1) + " χλμ • " + Math.round(summary.totalTime / 60) + " λεπτά";
            
            // Ενημέρωση πεδίων (Απλή αναφορά, το Leaflet Routing γεμίζει αυτόματα τα inputs του αλλά εμείς θέλουμε τα δικά μας)
            // Σημείωση: Το routing machine έχει δικά του inputs, εδώ απλά ενεργοποιούμε το κουμπί
            document.getElementById('sendBtn').disabled = false;
            
            // Παίρνουμε τα ονόματα των δρόμων (αν υπάρχουν)
            if (routes[0].waypoints) {
                 // Απλοϊκός τρόπος λήψης ονομάτων, ιδανικά θέλει Reverse Geocoding
                 document.getElementById('start').value = routes[0].waypoints[0].name || "Σημείο Α";
                 document.getElementById('end').value = routes[0].waypoints[1].name || "Σημείο Β";
            }
        });

        // --- Η ΣΥΝΑΡΤΗΣΗ ΤΗΣ ΧΡΕΩΣΗΣ (ΤΟ ΖΗΤΟΥΜΕΝΟ) ---
        function calculateComplexPrice(km) {
            let price = 0;
            
            // 1. Ελάχιστη χρέωση (0-1 χλμ)
            if (km <= 1) return 3.00;

            // Ξεκινάμε με 3€ για το πρώτο χιλιόμετρο
            price = 3.00;
            let remaining = km - 1;

            // 2. Ζώνη 1-4 χλμ (0.50€ ανά χλμ)
            if (remaining <= 3) {
                price += remaining * 0.50;
                return price;
            }

            // Αν είναι πάνω από 4 χλμ, προσθέτουμε όλο το κόστος της 2ης ζώνης (3 * 0.50 = 1.50€)
            price += 1.50;
            remaining -= 3; // Τώρα το remaining είναι τα χιλιόμετρα ΠΑΝΩ από το 4ο

            // 3. Ζώνη 4+ χλμ (Αύξηση 0.10€ ανά χλμ)
            // 5ο χλμ: 0.60€, 6ο χλμ: 0.70€, κλπ.
            let rate = 0.60;
            
            while (remaining > 0) {
                // Παίρνουμε 1 χλμ ή το υπόλοιπο (αν είναι π.χ. 0.4)
                let chunk = remaining >= 1 ? 1 : remaining;
                price += chunk * rate;
                
                remaining -= 1;
                rate += 0.10; // Αυξάνουμε την τιμή για το επόμενο χιλιόμετρο
            }

            return price;
        }

        // --- ΑΠΟΣΤΟΛΗ ΣΤΟ GOOGLE SCRIPT / SHIPDAY ---
        function sendOrder() {
            var phone = document.getElementById('phone').value;
            var start = document.getElementById('start').value; // Προσοχή: Στο Leaflet Routing τα Inputs είναι στον χάρτη
            var end = document.getElementById('end').value;
            var comments = document.getElementById('comments').value;

            // Αν ο χρήστης δεν έγραψε τηλέφωνο
            if (!phone) {
                alert("Παρακαλώ συμπληρώστε το τηλέφωνό σας!");
                return;
            }

            // UI: Εμφάνιση φόρτωσης
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('btnText').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            var orderData = {
                phone: phone,
                start: "Αφετηρία (Χάρτης)", // Θα χρειαστεί βελτίωση με Reverse Geocoding αργότερα
                end: "Προορισμός (Χάρτης)",
                comments: comments,
                price: calculatedPrice.toFixed(2),
                dist: document.getElementById('distDisplay').innerText
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            }).then(() => {
                alert("Η παραγγελία εστάλη επιτυχώς!");
                location.reload();
            }).catch(error => {
                alert("Σφάλμα: " + error);
                location.reload();
            });
        }
    </script>
</body>
</html>
