<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1E293B">
    <title>Î¤Î¿ Î ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï… | 2Fast Delivery</title>
    
    <style>
        :root { --primary: #FF5722; --secondary: #1E293B; --bg: #F1F5F9; --card: #FFFFFF; --text: #334155; --border: #E2E8F0; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); }
        
        .app-header { background: var(--secondary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .app-header h1 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .back-btn { background: rgba(255,255,255,0.1); color: white; text-decoration: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: bold; }
        
        .container { padding: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        .card { background: var(--card); padding: 22px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .title { color: var(--secondary); font-weight: 800; font-size: 15px; text-transform: uppercase; margin-bottom: 18px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; box-sizing: border-box; background: #F8FAFC; transition: 0.3s; color: var(--text); font-family: inherit; }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        .btn-update { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .btn-update:active { transform: scale(0.98); }
        
        .history-item { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; background: #F8FAFC; }
        .h-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #64748b; font-weight: bold; }
        .h-price { color: var(--primary); font-size: 16px; font-weight: 900; }
        .h-route { font-size: 14px; font-weight: 600; color: var(--secondary); line-height: 1.4; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: var(--secondary); }
    </style>
</head>
<body>
    <div id="loadingOverlay">â³ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î ÏÎ¿Ï†Î¯Î»...</div>
    <header class="app-header">
        <h1>ğŸ‘¤ Î¤Î¿ Î ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï…</h1>
        <a href="index.html" class="back-btn">ğŸ”™ Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</a>
    </header>

    <div class="container">
        <div class="card">
            <div class="title">âš™ï¸ Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ± Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</div>
            <div class="input-group">
                <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
                <input type="text" id="profName" placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚">
            </div>
            <div class="input-group">
                <label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿ Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚</label>
                <input type="tel" id="profPhone" placeholder="Î¤Î¿ ÎºÎ¹Î½Î·Ï„ÏŒ ÏƒÎ±Ï‚">
            </div>
            <div class="input-group">
                <label>Email (ÎœÎ· ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÎ¹Î¼Î¿)</label>
                <input type="email" id="profEmail" readonly style="opacity: 0.6; cursor: not-allowed;">
            </div>
            <div class="input-group">
                <label>Î ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚</label>
                <input type="text" id="profAddress" placeholder="ÎŸÎ´ÏŒÏ‚ & Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚">
            </div>
            <div class="input-group">
                <label>Î£Ï‡ÏŒÎ»Î¹Î± (ÎŒÏÎ¿Ï†Î¿Ï‚, ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹)</label>
                <textarea id="profNotes" rows="2" placeholder="Ï€.Ï‡. 2Î¿Ï‚ ÏŒÏÎ¿Ï†Î¿Ï‚, ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚"></textarea>
            </div>
            <button class="btn-update" onclick="updateProfile()" id="updateBtn">ğŸ’¾ Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³Ï‰Î½</button>
        </div>

        <div class="card">
            <div class="title">ğŸ“¦ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¹ÏÎ½</div>
            <div id="orderHistoryList">
                <div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 14px;">
                    Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¹ÏÎ½...
                </div>
            </div>
        </div>
        
        <button onclick="logoutUser()" style="width: 100%; padding: 15px; background: transparent; color: #ef4444; border: 2px solid #ef4444; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 10px;">
            ğŸ”´ Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
        </button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyDHmXVo-2kFvCFN3Q8U_MvJl_By_b6hs2w",
            authDomain: "fast-delivery-8227d.firebaseapp.com",
            projectId: "fast-delivery-8227d",
            storageBucket: "fast-delivery-8227d.firebasestorage.app"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserUid = null;

        // 1. Î•Î›Î•Î“Î§ÎŸÎ£ Î£Î¥ÎÎ”Î•Î£Î—Î£ & Î¦ÎŸÎ¡Î¤Î©Î£Î— Î”Î•Î”ÎŸÎœÎ•ÎÎ©Î
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.replace("login.html");
            } else {
                currentUserUid = user.uid;
                document.getElementById('profEmail').value = user.email || "Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ email";
                
                // Î¤ÏÎ±Î²Î¬Î¼Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Î¿Ï… Ï€ÏÎ¿Ï†Î¯Î»
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.name || data.n) document.getElementById('profName').value = data.name || data.n;
                        if (data.phone || data.p) document.getElementById('profPhone').value = data.phone || data.p;
                        if (data.address || data.a) document.getElementById('profAddress').value = data.address || data.a;
                        if (data.notes || data.txt) document.getElementById('profNotes').value = data.notes || data.txt;
                    }
                } catch (e) { console.log("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï€ÏÎ¿Ï†Î¯Î»:", e); }
                
                // ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î¿ loading
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Î¦Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ
                loadOrderHistory(user.uid);
            }
        });

        // 2. Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î— Î‘Î›Î›Î‘Î“Î©Î (Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î ÏÎ¿Ï†Î¯Î»)
        window.updateProfile = async function() {
            if (!currentUserUid) return;
            const btn = document.getElementById('updateBtn');
            btn.innerText = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·... â³";
            
            const newName = document.getElementById('profName').value;
            const newPhone = document.getElementById('profPhone').value;
            const newAddress = document.getElementById('profAddress').value;
            const newNotes = document.getElementById('profNotes').value;

            try {
                // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ merge: true Î³Î¹Î± Î½Î± ÎœÎ—Î ÏƒÎ²Î®ÏƒÎ¿Ï…Î¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î¼Ï€Î»Î¿ÎºÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î¿Ï‚ ÎºÎ»Ï€
                await setDoc(doc(db, "users", currentUserUid), {
                    name: newName,
                    phone: newPhone,
                    address: newAddress,
                    notes: newNotes
                }, { merge: true });
                
                alert("âœ… Î¤Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!");
                btn.innerText = "ğŸ’¾ Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³Ï‰Î½";
            } catch (error) {
                alert("âŒ Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚: " + error.message);
                btn.innerText = "ğŸ’¾ Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³Ï‰Î½";
            }
        };

        // 3. Î¦ÎŸÎ¡Î¤Î©Î£Î— Î™Î£Î¤ÎŸÎ¡Î™ÎšÎŸÎ¥ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î©Î
        async function loadOrderHistory(uid) {
            const historyList = document.getElementById('orderHistoryList');
            try {
                // Î¨Î¬Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ Ï…Ï€Î¿-Ï†Î¬ÎºÎµÎ»Î¿ "orders" Ï„Î¿Ï… ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
                const q = query(collection(db, "users", uid, "orders"), orderBy("timestamp", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎºÎ¬Î½ÎµÎ¹ Î±ÎºÏŒÎ¼Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚.</div>';
                    return;
                }

                let html = "";
                querySnapshot.forEach((docSnap) => {
                    const order = docSnap.data();
                    const dateObj = order.timestamp ? new Date(order.timestamp.toMillis()) : new Date();
                    const dateStr = dateObj.toLocaleDateString("el-GR") + " - " + dateObj.toLocaleTimeString("el-GR", {hour: '2-digit', minute:'2-digit'});
                    
                    html += `
                        <div class="history-item">
                            <div class="h-header">
                                <span>ğŸ“… ${dateStr}</span>
                                <span class="h-price">${order.price}</span>
                            </div>
                            <div class="h-route">ğŸ“ ${order.destination}</div>
                        </div>
                    `;
                });
                historyList.innerHTML = html;
            } catch (e) {
                console.log("Î£Ï†Î¬Î»Î¼Î± Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï:", e);
                historyList.innerHTML = '<div style="color: red; font-size: 13px;">Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï.</div>';
            }
        }

        // 4. Î‘Î ÎŸÎ£Î¥ÎÎ”Î•Î£Î—
        window.logoutUser = function() {
            signOut(auth).then(() => { window.location.replace("login.html"); });
        }
    </script>
</body>
</html>
